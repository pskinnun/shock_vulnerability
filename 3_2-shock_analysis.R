################################################
# Paper title:	Over half of the negative crop yield variability explained by anthropogenic indicators
# Authors:	Pekka Kinnunen*, Matias Heino, Vilma Sandstr√∂m, Maija Taka, Deepak K. Ray, Matti Kummu
##
# Code author: Pekka Kinnunen
# Script runs the analysis for crop yield variability ##
#######################################################


# join yield shock data with indicator data
yield_shock <- indicator_data %>%
  group_by(crop_name) %>%
  left_join(clim_anom_adj_yields, by = c("crop_name", "zones" = "area_id")) %>%
  left_join(harvested_area, by = c("zones" = "area_id", "crop_name")) %>%
  mutate(holdridge = as.character(holdridge)) %>%
  group_by_at(analysis_groups_shocks) %>%
  drop_na() %>%
  filter(n() > nthreshold,
         shock_type %in% shock_types) %>%
  group_split()


t_shock <- Sys.time()


# Fit models separately for each crop, Holdridge zone and shock type combination

print(paste("Shock run started", t_shock))

results_shocks <- fit_model_par(.df = yield_shock,
                           .group_names = analysis_groups_shocks,
                           .var_names = preds,
                           .target_name = target_shock,
                           .nfolds = nfolds,
                           .run_parallel = run_parallel,
                           .spacevar = spacevar,
                           .seeds = model_seeds,
                           .ncores = ncores)


print(Sys.time() - t_shock)


## unpack results

# predictions
shock_preds <- lapply(results_shocks, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge, shock_type) %>%
  summarise(obs_cor = cor(long_term_mean, preds),
            rsq = sign(obs_cor) * obs_cor^2,
            rmse = sqrt(mean((long_term_mean - preds)^2)),
            rmse_norm = rmse / (max(long_term_mean) - min(long_term_mean)),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order))

## grid point prediction accuracy
shock_rsq_grid_point <- lapply(results_shocks, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge,shock_type) %>%
  summarise(rsq = cor(long_term_mean, preds, method = "spearman")^2,
            rmse = sqrt(mean((long_term_mean -  preds)^2)),
            rmse_norm = rmse / sd(long_term_mean),
            #mae_norm = mean(abs(long_term_mean - preds)) / sd(long_term_mean),
            n_cells = n(),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order),
         crop_name = factor(crop_name, levels = crops_selected)) %>%
  filter(shock_type %in% c("hot","dry")) %>%
  filter(n_cells>100)

shock_rsq_continent_grid_point <- lapply(results_shocks, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge,shock_type, continent) %>%
  summarise(obs_cor =cor(long_term_mean, preds),
            rsq = sign(obs_cor) * obs_cor^2,
            rmse = sqrt(mean((long_term_mean -  preds)^2)),
            rmse_norm = rmse / sd(long_term_mean),
            mae_norm = mean(abs(long_term_mean - preds)) / sd(long_term_mean),
            n_cells = n(),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order),
         crop_name = factor(crop_name, levels = crops_selected)) %>%
  left_join(continent_names, by = c("continent" = "continent_id")) %>%
  filter(shock_type %in% c("hot","dry")) %>%
  filter(n_cells > 100)


# plots

ggplot(shock_preds) +
  geom_point(aes(x = shock_type, y = rmse_norm)) +
  facet_grid(crop_name ~ holdridge) +
  theme_bw()



mean_shock <- lapply(results_shocks, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge, shock_type) %>%
  summarise(pred_mean = mean(preds),
            actual_mean = mean(long_term_mean),
            max_pred = max(preds),
            max_actual = max(long_term_mean)) %>%
  pivot_longer(cols = pred_mean:actual_mean, names_to = "type")


shock_imp_data <- lapply(results_shocks, function(x) x$importances) %>%
  bind_rows()  %>%
  group_by(crop_name, holdridge, shock_type, Feature) %>%
  summarise(mean_gain = mean(Gain),
            median_gain = median(Gain),
            sd_gain  = sd(Gain), .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order))




if (save_temp_data) {
  save.image(file = paste0(path_to_results, '/shock_xgb_results', run_date, ".RData"))
}

