################################################
# Paper title:	Over half of the negative crop yield variability explained by anthropogenic indicators
# Authors:	Pekka Kinnunen*, Matias Heino, Vilma Sandstr√∂m, Maija Taka, Deepak K. Ray, Matti Kummu*
##
# Code author: Pekka Kinnunen
# Script plots variable distributions and pairwise correlations
###

cor_all <- indicator_data %>%
  pivot_longer(cols = all_of(preds),names_to = "indicator", values_to = "value") %>%
  mutate(indicator = recode(indicator, !!!pred_names),
           indicator = factor(indicator, unname(pred_names)))

var_ridges_plot <- ggplot(cor_all) +
  geom_density_ridges(aes(x = value, y = indicator)) +
  facet_grid(crop_name~holdridge) +
  xlim(0,1) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(cor_all) +
  geom_density_ridges(aes(x = value, y = indicator)) +
  facet_wrap(~holdridge) +
  xlim(0,1) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1))


if (save_results) {
  ggsave(paste0(path_to_results,"/variable_ridges_plot.pdf"),
         plot =var_ridges_plot, width = plot_width, height=plot_height)
}


zones_sample <- sample(unique(cor_all$zones), 10000)

indicator_sample <- cor_all %>%
    filter(zones %in% zones_sample) %>%
    group_by(zones, indicator) %>%
    slice_head(n = 1) %>%
    ungroup() %>%
    pivot_wider(id_cols = c(zones), names_from = indicator, values_from = value) %>%
    select(-zones)

cor_plot <- ggpairs(indicator_sample, mapping = ggplot2::aes(alpha = 0.5),
                      upper = list(continuous = "blank"),
                      lower = list(continuous = "cor"))+
    theme_bw() +
    theme(panel.grid = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          strip.background = element_blank())



if (save_results) {
  ggsave(filename = file.path(path_to_results, "variable_correlation_plot.pdf"),
         plot = cor_plot,
         width = plot_width-unit(2, "in"), height=plot_height-unit(2, "in"))
  }
if (show_results)  {
    print(cor_plot)
  }


#
# Timeseries of subnational hdi compared to 1995-2005
ts_shdi <-  read_shdi("../data/", indices = "shdi", years = ts_timeperiod) %>%
    raster_mean(., var_name = "shdi") %>%
    norm_values(., probs = scale_probs) %>%
    change_resolution(., res_to = res_in, cfun = "mean") %>%
    fill_na_values(., ref_area) %>%
    mask_by_crop_areas(., crop_area) %>%
    data_to_analysis_unit(data_in = .,
                          aunit_raster = aunit_raster,
                          aunit_data = analysis_unit_data)

ts_data <- bind_rows(ts_shdi) %>%
  select(-c(crop_name, holdridge, to07))

index_year <- 1995:2005

ts_data_index <- ts_data %>%
  group_by(indicator) %>%
  mutate(Year = Year %>%  str_remove("year") %>% as.numeric()) %>%
  filter(zones %in% sample(zones,5000)) %>%
  group_by(zones, indicator) %>%
  mutate(
         norm_val = mean(value[Year %in% index_year], na.rm = TRUE),
         value_dif = (value - norm_val)/value * 100
         ) %>%
  drop_na()

ts_diff_plot <- ggplot(data = ts_data_index %>% filter(indicator == "shdi"), aes(x = Year, y = value_dif)) +
 geom_line(aes(group = zones), color = "gray") +
  geom_smooth(method = "lm") +
  ylim(-100, 100) +
  ylab("%") +
  ggtitle("Difference between the annual values and mean of 1995-2005 for subnational HDI") +
  theme_bw() +
  theme(axis.title.y  = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    strip.background = element_blank(),
    axis.title.x = element_blank(), )

ts_diff_plot

if (save_results) {
  ggsave(paste0(path_to_results,"/", "timeseries_difference_shdi.pdf"),
         plot = ts_diff_plot,
         width = plot_width/2,
         height = plot_height/2,
         units = "in")
}



