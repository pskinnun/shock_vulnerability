
################################################
# Paper title:	Over half of the negative crop yield variability explained by anthropogenic indicators
# Authors:	Pekka Kinnunen*, Matias Heino, Vilma Sandstr√∂m, Maija Taka, Deepak K. Ray, Matti Kummu*
##
# Code author: Pekka Kinnunen
# Script plots figures for the manuscript
#################################################

# Plot distributions and sample sizes for yield variability and mean yields for shock years

yield_variability2 <- yield_variability %>%
  bind_rows() %>%
  mutate(crop_name = factor(crop_name, levels = crops_selected))

yield_variability_nobs <- yield_variability2 %>%
  group_by(crop_name, holdridge) %>%
  summarise(n_obs = n(), .groups = "drop") %>%
  mutate(n_obs_name = paste0("n=",n_obs) )

plot_yield_var_dist <- ggplot() +
  geom_density(data = yield_variability2,
               aes(x = yield_anom_var) , fill = shock_colors[[1]], alpha = 0.5) +
  ggrepel::geom_text_repel(
    data    = yield_variability_nobs,
    mapping = aes(x= 40, y= 0.35, label = n_obs_name), color = shock_colors[[1]],
    force= 0.2, min.segment.length = Inf,
  ) +
  xlab("yield loss risk [%]") +
  facet_grid(crop_name ~ holdridge) +
  scale_x_continuous(limits = c(-0,50))+
  guides(fill = "none", color = "none") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        strip.background = element_blank(),)
#axis.text.x = element_text(angle = 45, hjust = 1))

plot_yield_var_dist <- tag_facet(plot_yield_var_dist, open = "", close = "")

if(save_results) {
  ggsave(filename = file.path(path_to_results, "yield_variability_distribution.pdf"),
         plot = plot_yield_var_dist,
         width = plot_width, height = plot_height )
}


yield_shock2 <- yield_shock %>%
  bind_rows() %>%
  mutate(crop_name = factor(crop_name, levels = crops_selected))

yield_shock2_nobs <- yield_shock2 %>%
  group_by(crop_name, holdridge, shock_type) %>%
  summarise(n_obs = n(), .groups = "drop") %>%
  mutate(n_obs_name = paste0("n[", shock_type, "]==", n_obs)) %>%
  mutate(shock_type = case_when(shock_type == "dry" ~ "dry years",
                                TRUE ~ "hot years")) %>%
  mutate(x = 30, y = 0.15)


yield_shock2 <- yield_shock2 %>%
  mutate(shock_type = case_when(shock_type == "dry" ~ "dry years",
                                TRUE ~ "hot years"))


plot_mean_yield_shock <- ggplot() +
  geom_density(
    data = yield_shock2,
    mapping = aes(
      x = long_term_mean,
      fill = shock_type
    ) ,
    alpha = 0.5
  ) +
  ggrepel::geom_text_repel(
    data    = yield_shock2_nobs,
    mapping = aes(x= x, y= y, label = n_obs_name, color = shock_type),
    min.segment.length = Inf, direction = "y",
    parse = T
  ) +
  xlab("mean yield anomaly [%]") +
  facet_grid(crop_name ~ holdridge) +
  scale_fill_manual(breaks = c("dry years", "hot years"), values = shock_colors[2:3] ) +
  scale_color_manual(values = shock_colors) +
  scale_x_continuous(limits = c(-30,30))+
  guides(color = "none") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "bottom",legend.direction = "horizontal",
        axis.title.y = element_blank(),
        strip.background = element_blank(),
        legend.title = element_blank())


plot_mean_yield_shock <- tag_facet(plot_mean_yield_shock, open = "", close = "")

if(save_results) {
  ggsave(filename = file.path(path_to_results, "mean_yield_shock_distribution.pdf"),
         plot = plot_mean_yield_shock, width = plot_width, height = plot_height+unit(2,"in"))

}


# Plot explanatory power for all models
model_rsq_all_cases<-variability_rsq_grid_point %>%
  bind_rows(shock_rsq_grid_point) %>%
  mutate(crop_name = factor(crop_name, levels = crops_selected)) %>%
  mutate(shock_type = case_when(shock_type == "base case" ~ "1981-2009",
                                shock_type == "dry" ~ "dry years",
                                shock_type == "hot" ~ "hot years"))


mean_expl_power_holdridge <- model_rsq_all_cases %>%
  group_by(shock_type, holdridge) %>%
  summarise(mean_rsq = mean(rsq, na.rm=T),
            .groups = "keep")

mean_expl_power_crops <- model_rsq_all_cases %>%
  group_by(shock_type, crop_name) %>%
  summarise(mean_rsq = mean(rsq, na.rm=T),
            .groups = "keep")


segment_size = 0.2

shock_colors <- inlmisc::GetColors(n = 3, scheme = "high-contrast")

names(shock_colors) <- c("1981-2009","dry years","hot years")

plot_rsq_a <- ggplot() +
  geom_point(data = model_rsq_all_cases,
             aes(y = shock_type, x = rsq*100, color = shock_type), alpha = 0.7, size = 1) +
  scale_color_manual(values = shock_colors) +
  geom_vpline(data = mean_expl_power_holdridge, aes(x =mean_rsq*100, y = shock_type, color=shock_type), lwd = 1) +
  #scale_color_manual(values = crop_colors) +
  facet_wrap(~ holdridge, ncol = 2,strip.position = "top") +
  guides(color = "none") +
  xlim(0,80) +
  xlab("Variation explained [%]") +
  #ggtitle("Average Rsquared for Holdridge zones") +
  theme_minimal() +
  theme(#axis.title  = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(linetype = "dashed"),
        strip.background = element_blank(),
        strip.placement = "outside",
        axis.line.x = element_line(),
        axis.ticks.x = element_line(),
        axis.ticks.y = element_line(),
        axis.title.y = element_blank()
        #axis.text.y = element_blank()
        )

plot_rsq_a

if(save_results) {
ggsave(plot = plot_rsq_a, filename = file.path(path_to_results, "plot_mean_rsq_holdridge.pdf"),
       width = (unit(5.5,"in")),
       height = plot_height/ (6/3))
}

plot_rsq_b <- ggplot() +
  geom_point(data = model_rsq_all_cases,
             aes(y = shock_type, x = rsq*100, color = shock_type), alpha = 0.7, size = 1) +
  scale_color_manual(values = shock_colors) +
  geom_vpline(data = mean_expl_power, aes(x =mean_rsq*100, y = shock_type, color = shock_type), lwd = 1) +
  #scale_color_manual(values = crop_colors) +
  facet_wrap(~ crop_name, ncol =2,strip.position = "top") +
  guides(color = "none") +
  xlab("Variation explained [%]") +
  xlim(0,80) +
  #ggtitle("Average Rsquared for Holdridge zones") +
  theme_minimal() +
  theme(axis.title.y  = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(linetype = "dashed"),
        strip.background = element_blank(),
        strip.placement = "outside",
        axis.line.x = element_line(),
        axis.ticks.x = element_line()
        #axis.text.y = element_blank()
        )

plot_rsq_b
if(save_results) {
ggsave(plot = plot_rsq_b, filename = file.path(path_to_results, "plot_mean_rsq_crops.pdf"),
       width = (unit(5.5,"in")),
       height = plot_height/(6/2))
}


## Plot variable importances

var_imps_combined <- bind_rows(var_imp_data, shock_imp_data) %>%
  filter(shock_type %in% c("base case","dry","hot")) %>%
  mutate(shock_type = case_when(shock_type == "base case" ~ "1981-2009",
                                shock_type == "dry" ~ "dry years",
                                shock_type == "hot" ~ "hot years")) %>%
  mutate(crop_name = factor(crop_name, levels = crops_selected),
         holdridge = factor(holdridge, levels = holdridge_order)) %>%
  mutate(Feature_abrv = recode(Feature, !!!pred_names),
         Feature_abrv = factor(Feature_abrv, unname(pred_names)))


plot_var_imps <-ggplot(var_imps_combined, aes( y= shock_type, x = mean_gain, color = shock_type, fill =shock_type)) +
   ggdist::stat_halfeye(
     adjust = .5,
     width = .6,
     .width = 0,
     justification = -.3, alpha = 0.7,
     point_colour = NA) +
  scale_color_manual(values = shock_colors) +
  scale_fill_manual(values = shock_colors) +
   # geom_boxplot(width = .25,
   #               outlier.shape = NA) +
  geom_point(size = 1.3,
             alpha = 0.3 ) +
  stat_summary(fun=mean, geom = "vpline", lwd = 1) +
    # position = position_jitter(
    #   seed = 1, width = .1 )+
  guides(color = "none", fill = "none") +
  xlab("Mean variable importance") +
  facet_wrap(~Feature_abrv, ncol = 2, strip.position = "top") +
   theme_minimal() +
  theme(strip.placement = "outside",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(linetype ="dashed"),
        panel.grid.minor = element_blank(),
        axis.title.y = element_blank(),
        axis.line.x = element_line(),
        axis.ticks.x = element_line()

        #axis.text.y = element_blank()
        )

plot_var_imps <- tag_facet(plot_var_imps, open ="", close ="")

if(save_results) {
  ggsave(plot = plot_var_imps, filename = file.path(path_to_results, "plot_variable_importances.pdf"),
         width = plot_width - unit(1,"in"), height = plot_height -unit(2,"in"))
}




# Calculate and plot ALEplot for yield variability and mean shock yields
## Define the predictive function
yhat <- function(X.model, newdata) as.numeric(predict(X.model, newdata, type="raw"))


# ALEplot yield variability

ale_data_variability <- tibble()
for(j in 1:length(results_variability)) {
  df <- results_variability[[j]]$outcome_preds

  models <- results_variability[[j]]$models

  model_id <- tibble(drop = names(models)[1]) %>%
    separate(into = c("crop_name","holdridge"), col = drop, sep ="//",extra = "drop")


  for(k in 1:length(models)) {
    ale_dat <-df %>%
      filter(fold_n != paste0("fold_",k)) %>%
      select(yield_anom_var, all_of(preds)) %>%
      as.matrix()

    mod <- models[[k]]$finalModel
    ale_plots <- lapply(seq(1,6), function(x) ALEPlot(ale_dat[,2:7], mod, pred.fun = yhat, J=x, K =20))

    names(ale_plots) <- preds

    out <- lapply(ale_plots, function(x) {
      tibble(x.values = x$x.values,
             f.values = x$f.values) } ) %>%
      bind_rows(.id = "indicator") %>%
      mutate(group_n = k) %>%
      bind_cols(model_id)

    ale_data_variability <- ale_data_variability%>%
      bind_rows(out) %>%
      mutate(shock_type = "1981-2009")

  }
}


ale_data_shocks <- tibble()
# ALEplot for shock yields

for(j in 1:length(results_shocks)) {
  df <- results_shocks[[j]]$outcome_preds

  models <- results_shocks[[j]]$models

  model_id <- tibble(drop = names(models)[1]) %>%
    separate(into = c("crop_name","holdridge","shock_type"), col = drop, sep ="//",extra = "drop")


  for(k in 1:length(models)) {
    ale_dat <-df %>%
      filter(fold_n != paste0("fold_",k)) %>%
      select(long_term_mean, all_of(preds)) %>%
      as.matrix()

    mod <- models[[k]]$finalModel
    ale_plots <- lapply(seq(1,6), function(x) ALEPlot(ale_dat[,2:7], mod, pred.fun = yhat, J=x, K =20))

    names(ale_plots) <- preds

    out <- lapply(ale_plots, function(x) {
      tibble(x.values = x$x.values,
             f.values = x$f.values) } ) %>%
      bind_rows(.id = "indicator") %>%
      mutate(group_n = k) %>%
      bind_cols(model_id)

    ale_data_shocks <- ale_data_shocks %>%
      bind_rows(out)

  }
}


indicators_filtered <- c( "shdi", "fertilizerPCA")

ale_data_variability_filtered<-  ale_data_variability %>%
  filter(indicator %in% indicators_filtered) %>%
  mutate(crop_name = factor(crop_name, levels = crops_selected),
         holdridge = factor(holdridge, levels = holdridge_order))


plot_ale_variability_shdi_fert <- ggplot(ale_data_variability_filtered) +
  geom_smooth(aes(x = x.values,
                  y = f.values,
                  color = indicator),
              method = "loess") +
  scale_x_continuous(breaks = c(0,0.5,1)) +
  scale_color_brewer(palette = "Dark2") +
  #scale_y_reverse() +
  facet_grid(crop_name ~ holdridge) +
  ylab(" ") +
  xlab("indicator values") +
  guides (color = "none") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())

plot_ale_variability_shdi_fert



if(save_results) {
  ggsave(plot = plot_ale_variability_shdi_fert ,
         filename = file.path(path_to_results, "plot_ale_variability_shdi_fertilizer.pdf"),
         width = plot_width, height = plot_height )
}

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")




ale_data_filtered <-  ale_data_shocks %>%
  filter(indicator %in% indicators_filtered) %>%
  mutate(crop_name = factor(crop_name, levels = crops_selected),
         holdridge = factor(holdridge, levels = holdridge_order))


plot_ale_shdi_fertilizer <- ggplot(ale_data_filtered,aes(x = x.values,
                                                         y = f.values, color = indicator, linetype = shock_type))+
  #color = interaction(indicator, shock_type, sep = " + "))) +
  geom_smooth(method = "loess",level = 0.95) +
  scale_x_continuous(breaks = c(0,0.5,1)) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(crop_name ~ holdridge) +
  ylab(" ") +
  xlab("indicator values") +
  guides (color = FALSE, linetype =FALSE) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        #strip.text = element_blank(),
        #axis.text = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank())
plot_ale_shdi_fertilizer


if (save_results) {
  ggsave(plot = plot_ale_shdi_fertilizer, filename = file.path(path_to_results, "plot_ale_shdi_fertilizer.pdf"),
         width = plot_width, height = plot_height )
}

