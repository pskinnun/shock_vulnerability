################################################
# Paper title:	Over half of the negative crop yield variability explained by anthropogenic indicators
# Authors:	Pekka Kinnunen*, Matias Heino, Vilma Sandstr√∂m, Maija Taka, Deepak K. Ray, Matti Kummu
##
# Code author: Pekka Kinnunen
# Script runs the analysis for crop yield variability ##
#######################################################


# join indicator data and crop data
yield_variability <- indicator_data %>%
  left_join(crop_yield_var, by = c("crop_name","zones" = "area_id")) %>%
  left_join(harvested_area, by = c("zones" = "area_id", "crop_name")) %>%
  mutate(holdridge = as.character(holdridge)) %>%
  mutate_at(.vars = c(all_of(preds), "yield_anom_var"),
            round, digits = 3) %>%
  group_by_at(analysis_groups) %>%
  drop_na() %>%
  filter(dplyr::n() > nthreshold) %>%
  group_split()


# Fit models separately for each crop and Holdridge zone combinations

t_start <- Sys.time()

print(paste("run started", t_start))

results_variability <- fit_model_par(.df = yield_variability,
                                    .nfolds = nfolds,
                                    .var_names = preds,
                                    .group_names = analysis_groups,
                                    .target_name = target_name,
                                    .run_parallel = run_parallel,
                                    .spacevar = spacevar,
                                    .seeds = model_seeds,
                                    .ncores = ncores)

print(Sys.time() - t_start)


## unpack results

# model performance for each test split
# variability_rsq <- lapply(results_variability, function(x) x$prediction_perf) %>%
#   bind_rows() %>%
#   group_by(crop_name, holdridge) %>%
#   mutate(rsq_mean = mean(Rsquared, na.rm = T),
#             rsq_sd = sd(Rsquared, na.rm = T),
#             rmse_mean = mean(RMSE),
#             rmse_sd = sd(RMSE), .groups = "keep") %>%
#   mutate(holdridge = factor(holdridge, levels = holdridge_order),
#          crop_name = factor(crop_name, levels = crops_selected))


# predictions
variability_preds <- lapply(results_variability, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge) %>%
  summarise(
    obs_cor = cor(yield_anom_var, preds),
    rsq = sign(obs_cor)*obs_cor^2,
    rmse = sqrt(mean((yield_anom_var - preds)^2)),
    rmse_norm = rmse / (max(yield_anom_var) - min(yield_anom_var)),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order))

variability_rsq_continent <- lapply(results_variability, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge, continent) %>%
  summarise(rsq = (cor(preds, yield_anom_var))^2,
            rmse = sqrt(mean((yield_anom_var - preds)^2)),
            rmse_norm = rmse / sd(yield_anom_var),
            mae_norm = mean(abs(yield_anom_var - preds)) / sd(yield_anom_var),
            n_cells = n(),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order),
         crop_name = factor(crop_name, levels = crops_selected)) %>%
  left_join(continent_names, by = c("continent" = "continent_id"))


variability_nrmse <- lapply(results_variability, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge) %>%
  summarise(rsq = (cor(preds, yield_anom_var))^2,
            rmse = sqrt(mean((yield_anom_var - preds)^2)),
            rmse_norm = rmse / sd(yield_anom_var),
            mae_norm = mean(abs(yield_anom_var-preds)) / sd(yield_anom_var),
            n_cells = n(),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order),
         crop_name = factor(crop_name, levels = crops_selected)) %>%
  filter(n_cells>100)

ggplot(variability_nrmse ) +
  geom_point(aes(x = holdridge, y = rmse_norm)) +
  facet_wrap(~crop_name) +
  guides(color =FALSE) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())


variability_rsq_grid_point <- lapply(results_variability, function(x) x$outcome_preds) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge) %>%
  summarise(rsq = cor(yield_anom_var, preds)^2,
            rmse = sqrt(mean((yield_anom_var -  preds)^2)),
            rmse_norm = rmse / (max(yield_anom_var) - min(yield_anom_var)),
            n_cells = n(),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order),
         shock_type = "base case")


# variable importances
var_imp_data <-lapply(results_variability, function(x) x$importances) %>%
  bind_rows() %>%
  group_by(crop_name, holdridge,Feature) %>%
  summarise(mean_gain = mean(Gain),
            median_gain = median(Gain),
            sd_gain = sd(Gain),
            .groups = "keep") %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order)) %>%
  mutate(shock_type = "base case")



if (save_temp_data) {
  save.image(file = paste0( path_to_results,'/yield_variance_data_', run_date, '.RData'))
  #load(file = paste0( path_to_results,'/yield_variance_data_', run_date, '.RData'))
  }

