
################################################
# Paper title:	Over half of the negative crop yield variability explained by anthropogenic indicators
# Authors:	Pekka Kinnunen*, Matias Heino, Vilma Sandstr√∂m, Maija Taka, Deepak K. Ray, Matti Kummu*
##
# Code author: Pekka Kinnunen
# Script plots mapped visualizations
#################################################
#

equal_earth <- "+proj=eqearth +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
robin <- "+proj=robin +lon_0=0 +x_0=-180 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
crop_colors <- c(maize = "#333BFF", wheat = "#CC6600", rice = "#9633FF", soybean = "#E2FF33")

lands <- rnaturalearth::ne_countries(returnclass = "sp") %>%
  subset(.,.$sovereignt != "Antarctica") %>%
  gUnaryUnion(.) %>%
  st_as_sf()

lands <- st_transform(lands, crs = robin)

crs_out <- crs(lands)

# transform and plot holdridge areas
holdridge <- st_transform(holdridge, "+proj=robin")

plot_holdridge_areas <- ggplot() +
  geom_sf(data = crop_holdridge %>% filter(holdridge != "Polar and cold"),aes(fill = holdridge), lwd = 0 ) +
  geom_sf(data = lands,lwd = 0.2, alpha = 0.2) +
  scale_fill_manual(values=holdridge_colors) +
  coord_sf(crs = robin) +
  facet_wrap(~crop_name ) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_blank())

plot_holdridge_areas

if (save_results) {
  ggsave(filename = file.path(path_to_results, 'map_holdridge_areas.pdf'),
         plot = plot_holdridge_areas,
       height = plot_height/2, width = plot_width)
}



## map variance for these shock types
viridis_palette <- viridis::viridis(n = 256,direction = -1)


# Plot yield variability relative to the mean of Holdridge zones

variability_holdridge <- crop_yield_var %>%
  left_join(analysis_unit_data, by = c("area_id" = "gridCell")) %>%
  left_join(harvested_area, by = c("area_id","crop_name")) %>%
  drop_na() %>%
  group_by(crop_name, holdridge) %>%
  mutate(var_holdridge =  weighted.mean(yield_anom_var,harv_area, na.rm = T),
          relative_var = yield_anom_var - var_holdridge)


ggplot(variability_holdridge) +
  geom_density_ridges(aes(x = relative_var, y = crop_name)) +
  facet_wrap(~holdridge)

# loop over crops and create raster for yield variance in holdridge zones
stack_yield_var <- stack()
for (crop_in in crops_selected) {
      df <- variability_holdridge %>%
        filter(crop_name == crop_in) %>%
        ungroup()

      area_ids <- df %>%
        pull(area_id) %>%
        unique()

      rcl <- df %>%
        dplyr::select(area_id, relative_var) %>%
        as.matrix()

      r_out <- cell_ids
      r_out[!r_out %in% area_ids ] <- NA
      rcl_r <- raster::reclassify(r_out, rcl = rcl)

      names(rcl_r) <- crop_in

      stack_yield_var <- stack(stack_yield_var, rcl_r)
}

plot(stack_yield_var)

# breaks for the variance calculation
#breaks_var <- c(-50,-25, -10,-5,0,5,10,25,50)
breaks_var <- seq(-20,20,5)

# reproject the raster and plot it
stack_yield_var <- raster::projectRaster(stack_yield_var, crs = crs_out)

plot_yield_var <- tm_shape(stack_yield_var) +
  tm_raster(palette = "viridis", legend.show = T, style = "fixed", breaks = breaks_var) +
  tm_style("white",legend.show =  T,
           frame = F,
           bg.color = "NA",
           earth.boundary = T,
           n = 7,
           space.color = "white",
           panel.show = T,
           legend.is.portrait = F) +
  # add coastline
  tm_shape(lands,projection = "robin") +
  tm_borders(col="black",alpha = 1, lwd = 0.5)+
  tm_layout(legend.bg.color = TRUE,
            legend.outside.position = "bottom",
            legend.outside = TRUE,
            frame = FALSE,
            earth.boundary = T,
            earth.boundary.lwd = NA,
            earth.boundary.color = "white",
            panel.show = F,) +
  tm_facets(ncol = 2)


plot_yield_var

# colorbar variability
cbar_variance <- tm_shape(stack_yield_var) +
  tm_raster(palette = "-RdBu", legend.show = T, style = "fixed",
            breaks = breaks_var) +
  tm_facets(free.scales = FALSE, nrow = 1) +
  tm_style("white",
           frame = F, bg.color="white", earth.boundary = F,
           space.color = "white", panel.show = F,legend.only = T)


if (save_results) {
tmap_save(plot_yield_var,
          height = as.numeric(plot_height) ,
          width = as.numeric(plot_width) ,
          units = "in",
          filename = paste0(path_to_results,"/map_yield_variance_holdridge.pdf"))

tmap_save(cbar_variance,
          filename = paste0(path_to_results,
                            "/map_yield_variance_holdridge_cbar.pdf"))

}

# Plot  mean shocks relative to the Holdridge zone means
clim_yields_holdridge <- clim_anom_adj_yields  %>%
  left_join(analysis_unit_data, by = c("area_id" = "gridCell")) %>%
  left_join(harvested_area, by = c("area_id","crop_name")) %>%
  group_by(crop_name, shock_type, holdridge) %>%
  mutate(holdridge_mean = weighted.mean(long_term_mean,w = harv_area),
         relative_mean = (long_term_mean - holdridge_mean)) %>%
  filter(shock_type %in% shock_types)


# calculate mean shock effect for each Holdridge zone
mean_shock_effect <- clim_yields_holdridge%>% group_by(holdridge, crop_name, shock_type) %>%
  slice_head(n = 1) %>%  select(-c(area_id, long_term_mean, harv_area, relative_mean)) %>%
  mutate(shock_type = case_when(shock_type == "dry" ~ "dry years",
                                TRUE ~ "hot years")) %>%
  drop_na() %>%
  filter(holdridge %in% holdridge_order) %>%
  mutate(holdridge = factor(holdridge, levels = holdridge_order),
         crop_name = factor(crop_name, levels = crops_selected))

plot_mean_shock_effect <- ggplot(mean_shock_effect) +
  geom_point(aes(x = holdridge, y = holdridge_mean)) +
  facet_grid(crop_name ~ shock_type) +
  ylim(-9,5) +
  theme_bw() +
  theme(axis.title  = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.placement = "outside",
        axis.line.x = element_line(),
        axis.text.x = element_text(angle = 45, hjust =1),
        axis.ticks.x = element_line()
        #axis.text.y = element_blank()
  )

if(save_results) {
ggsave(filename = file.path(path_to_results, 'plot_holdridge_mean_effect_shock_years.pdf'),
       plot =plot_mean_shock_effect, width = plot_width - unit(2, "in"), height = plot_height - unit(2, "in"))
}



 # plot rasters

stack_relative_mean_shock <- stack()
 for (crop_in in crops_selected) {

   for (shock in shock_types ) {

     df <- clim_holdridge %>% filter(shock_type == shock,
                                          crop_name == crop_in) %>%
       ungroup()

     ids <- df %>%
       pull(area_id) %>% unique()

     rcl <-df %>%
       select(area_id, relative_mean) %>%
       as.matrix()

     r_temp <- cell_ids

     r_temp[!r_temp %in% ids ] <- NA

     rcl_r <- raster::reclassify(r_temp, rcl = rcl)

     names(rcl_r) <- paste(crop_in,shock, sep ="_")

     stack_relative_mean_shock <- stack(stack_relative_mean_shock, rcl_r)
   }
 }

plot(stack_relative_mean_shock)

breaks_shock <- seq(-20,20,5)


pal_mean_shock <- scico::scico(100,direction = -1, palette = "vik")

plot_map_relative_mean <- tm_shape(stack_relative_mean_shock) +
   tm_raster(palette = pal_mean_shock , style = "fixed", breaks = breaks_shock)+
  tm_style("white",
           legend.show =  F,
           bg.color = "NA",
           earth.boundary = T,
           n = 7,
           space.color = "white",
           panel.show = T,
           legend.is.portrait = F) +
  # add coastline
  tm_shape(lands,projection = "robin") +
  tm_borders(col="black", lwd = 0.5)+
  tm_layout(legend.bg.color = TRUE,
            legend.outside.position = "bottom",
            legend.outside = TRUE,
            frame = FALSE,
            frame.lwd = NA, panel.label.bg.color = NA,earth.boundary = T,
            earth.boundary.lwd = NA,
            earth.boundary.color = "white",
            panel.show = F) +
   tm_facets(free.scales = FALSE, nrow = 4)

plot_map_relative_mean



cbar_shocks <- tm_shape(stack_relative_mean_shock) +
  tm_raster(palette =pal_mean_shock ,legend.show = T, style="fixed",
            breaks = breaks_shock) +
  tm_facets(free.scales = FALSE, nrow = 2) +
  tm_style("white",legend.show = T,
           frame = F, bg.color="white", earth.boundary = T,
           space.color="white", panel.show = F,legend.only = T)

cbars <- tmap_arrange(cbar_variance, cbar_shocks)

if (save_results) tmap_save(cbars, filename=paste0(path_to_results,"/cbars_outcomes_to_mean_holdridge.pdf"))



stack_relative_mean_shock <- raster::projectRaster(stack_relative_mean_shock, crs = crs_out)


plot_raster_im(s_in = stack_relative_mean_shock,
                pal = pal_mean_shock,
               breaks = breaks_shock,
               land_outline = lands,
               plot_size = 1.5,
              plot_name = "mean_relative_yield_shock")

plot_raster_im(stack_yield_var,
               pal = "-RdBu",
               breaks = breaks_var,
               land_outline = lands,
               plot_size = 1.25,
               plot_name = "yield_relative_downside_risk")


if(save_results) {

  # saving maps
  tmap_save(plot_map_relative_mean,
            filename = paste0(path_to_results, "/map_mean_shocks_relative_holdridge.pdf"),
            height = as.numeric(plot_height) ,
            width = as.numeric(plot_width) ,
            units = "in")

  tmap_save(cbar_shocks,
            filename = paste0(path_to_results,
                              "/map_mean_shocks_relative_holdridge_cbar.pdf"))
}

clim_holdridge <- clim_anom_adj_yields  %>%
   left_join(analysis_unit_data, by = c("area_id" = "gridCell")) %>%
   filter(shock_type %in% shock_types)

 stack_actual_mean_shock <- stack()
 for (crop_in in crops_selected) {

   for (shock in shock_types ) {

     df <- clim_holdridge %>% filter(shock_type == shock,
                                     crop_name == crop_in) %>%
       ungroup()

     ids <- df %>%
       pull(area_id) %>% unique()

     rcl <-df %>%
       select(area_id, long_term_mean) %>%
       as.matrix()

     r_temp <- cell_ids

     r_temp[!r_temp %in% ids ] <- NA

     rcl_r <- raster::reclassify(r_temp, rcl = rcl)

     names(rcl_r) <- paste(crop_in,shock, sep ="_")

     stack_actual_mean_shock  <- stack( stack_actual_mean_shock , rcl_r)
   }
 }

 plot( stack_actual_mean_shock )

 breaks_shock <- seq(-20,20,5)

 stack_actual_mean_shock  <- raster::projectRaster( stack_actual_mean_shock ,
                                                    crs = robin)

 plot_map_shock_mean <- tm_shape( stack_actual_mean_shock ) +
   tm_raster(palette = "RdBu" ,legend.show = F, style = "fixed", breaks = breaks_shock)+
   tm_facets(free.scales = FALSE, nrow = 4) +
   tm_style("white",legend.show = T,
            frame = F, bg.color = "white", earth.boundary = T,
            space.color="white", panel.show = T) +
   # add coastline
   tm_shape(lands) +
   tm_polygons("white", lwd = 0.2, alpha = 0.1) +
   tm_layout(frame = FALSE, frame.lwd = NA, panel.label.bg.color = NA)

 plot_map_shock_mean

 tmap_save(tm = plot_map_shock_mean,
           filename=paste0(path_to_results, "/map_mean_shocks_actual.pdf"),
           height = as.numeric(plot_height) ,
           width = as.numeric(plot_width) ,
           units = "in")


models_rsq_continent <- variability_rsq_continent %>%
  mutate(shock_type = "base case") %>%
  bind_rows(shock_rsq_continent_grid_point) %>%
  filter(shock_type %in% c("base case","dry","hot"))


crop_holdridge_continent <- st_intersection(holdridge_crs, crop_continent) %>%
  left_join(models_rsq_continent, by = c("crop_name","holdridge", "continent_name")) %>%
  filter(!is.na(rsq))  %>%
  sf::st_collection_extract("POLYGON") %>%
  mutate(rsq_class = cut(rsq* 100, seq(0,1,0.1)* 100) ) %>%
  st_transform(crs = st_crs(lands))


holdridge_continent_data <- st_intersection(holdridge_crs, crop_continent) %>%
  left_join(models_rsq_continent, by = c("crop_name","holdridge", "continent_name")) %>%
  st_drop_geometry() %>%
  as_tibble() %>%
  drop_na()

holdridge_continent_data %>%
  group_by(crop_name, continent_name, holdridge) %>%
  filter(n_cells>100) %>%
  summarise(max(rsq)) %>%
  view()

pal_rsq <- scico(n = 10,palette = "batlow", direction = -1)
breaks_rsq <-seq(0, 1,0.1) * 100

for (crop_in in crops_selected) {
  for (shock_in in c("base case",shock_types)) {
    df <- crop_holdridge_continent %>%
      filter(crop_name == crop_in,
             shock_type ==  shock_in)

  map_rsq_out <- # add coastline
    tm_shape(lands,projection = robin) +
    tm_polygons( lwd = 0.2, alpha = 0.1) +
    tm_layout(frame = FALSE, frame.lwd = NA,
              panel.label.bg.color = NA) +
  tm_shape( df, projection = robin) +
    tm_fill(col = "rsq_class", palette = pal_rsq,
                legend.show = F,
                style = ,
                breaks = breaks_rsq) +
    tm_style("white",legend.show = T,
             frame = F, bg.color = "white", earth.boundary = T,
             earth.boundary.lwd = NA,
             earth.boundary.color = "white",
             space.color="white", panel.show = F)


  tmap_save(tm = map_rsq_out,
            filename = paste0(path_to_results, "/map_rsq_continent_", crop_in,"_",shock_in, ".pdf"),
            height = as.numeric(1.5) ,
            width = as.numeric(1.5)*2 ,
  units = "in")
  map_rsq_out

  }
}

cbar_rsq <- tm_shape(df) +
  tm_fill(col = "rsq_class", palette = pal_rsq,
          legend.show = T,
          style = ,
          breaks = breaks_rsq) +
  tm_style(style = "white", legend.only = T)

if (save_results) {
  tmap_save(tm= cbar_rsq,
            filename = paste0(path_to_results, "/map_rsq_continent_colorbar.pdf"),
            height = as.numeric(1.5),
            width = 2,
            units = "in")
}

######
