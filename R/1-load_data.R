################################################
# Paper title:	Over half of the negative crop yield variability explained by anthropogenic indicators
# Authors:	Pekka Kinnunen*, Matias Heino, Vilma Sandstr√∂m, Maija Taka, Deepak K. Ray, Matti Kummu*
##
# Code author: Pekka Kinnunen
# Script loads indicator and crop yield data

###



# analysis unit

aunit_filename <- "temp_data/analysis_unit.tif"
analysis_unit_path <- aunit_filename

cell_ids <- r_temp
values(cell_ids) <- 1:(360 * 720)

# create crop specific and total reference area where are some crop yields
# crop area masks indicator values to areas where there are crop specific yields
crop_area <- load_crop_data(crops_selected,
                            path_to_crop_data,
                            years = years_selected,
                            temp_raster = r_temp,
                            output = "weights" )

crop_harvested_area <- load_crop_data(crop_names = crops_selected,
                            path_crop_data = path_to_crop_data,
                            years = years_selected,
                            var_name = "harvestedarea",
                            temp_raster = r_temp,
                            output = FALSE ) %>%
  sum(., na.rm = T) / 100


 # ref area is used to fill missing data, eg some coastal areas.
ref_area <- sum(crop_area, na.rm = T)
ref_area[all(is.na(crop_area))] <- NA

states <- st_read("../data/combined_borders/combined_borders.shp") %>%
  filter(area_name != "Antarctica") %>%
  mutate(state_id = row_number())


if (analysis_level == "grid") {
  # create analysis unit on raster grid level

  aunit_raster <- make_analysis_unit(cell_ids,
                                     save_temp = TRUE,
                                     filename = aunit_filename)
  names(aunit_raster) <- "gridCell"

  rholdridge <- fasterize(holdridge, raster = r_temp, field = "to07") %>%
    fill_na_values(., ref_area, max_distance = 6)

  names(rholdridge) <- "to07"

  aunit_data <- st_drop_geometry(holdridge)

  analysis_unit_data <- values(stack(aunit_raster, rholdridge)) %>%
    as_tibble() %>%
    drop_na() %>%
    left_join(aunit_data, by = c("to07")) %>%
    mutate(holdridge = as.character(holdridge))


} else {
  # not implemented
  stop()
}


## load, normalise and reproject indicators

# Subnational hdi and governance indicators

subnat_hdi <-  read_shdi("../data/", indices = "shdi", years = years_selected) %>%
    raster_mean(., var_name = "shdi") %>%
    norm_values(., probs = scale_probs) %>%
  change_resolution(., res_to = res_in, cfun = "mean") %>%
  fill_na_values(., ref_area) %>%
  mask_by_crop_areas(., crop_area) %>%
  data_to_analysis_unit(data_in = .,
                        aunit_raster = aunit_raster,
                        aunit_data = analysis_unit_data)

governance <- read_hdi_gdp("../data/", variable = "governance", years = years_selected) %>%
  raster_mean(., "governance") %>%
  norm_values(., probs = scale_probs) %>%
  change_resolution(., res_to = res_in, cfun = "mean") %>%
  fill_na_values(., ref_area) %>%
  mask_by_crop_areas(., crop_area) %>%
  data_to_analysis_unit(data_in = .,
                        aunit_raster = aunit_raster,
                        aunit_data = analysis_unit_data,
                        indicator_name = "governance")

# Agricultural indicators

irrigation <- read_irrigation("../data/HID_v10/", years = years_selected) %>%
  mean(., na.rm = TRUE) %>%
  change_resolution(., res_to = res_in, cfun = "mean") %>%
  mask_by_crop_areas(., crop_area) %>%
  norm_values(., probs = c(0,1)) %>%
  data_to_analysis_unit(data_in = .,
                        aunit_raster = aunit_raster,
                        aunit_data = analysis_unit_data,
                        indicator_name = "irrigation")

water_stress <- read_wri_waterstress (path_to_data = "../data/",ref_r = r_temp) %>%
  fill_na_values(., ref_area) %>%
  mask_by_crop_areas(., crop_area) %>%
  data_to_analysis_unit(data_in = .,
                        indicator_name = "waterstress",
                        aunit_raster = aunit_raster,
                        aunit_data = analysis_unit_data)




fert_fractions <- c("N", "P", "K")

fertilizers <- read_fertilizer_consumption(path_in = "../data/",
                                           crop_name = crops_selected,
                                           data_source = "earthstat",
                                           fertilizer = fert_fractions) %>%
  change_resolution(., res_to = res_in) %>%
  mask_by_crop_areas(., crop_area) %>%
  do_raster_pca(., "fertilizerPCA", 1) %>%
  norm_values(., probs = scale_probs) %>%
  data_to_analysis_unit(data_in = .,
                        aunit_raster = aunit_raster,
                        aunit_data = analysis_unit_data,
                        cfun = "mean")


suitability <- read_FAO_GAEZ("../data/FAO_GAEZ/",
                             si_level = c("intermediate"),
                             crops = crops_selected) %>%
  mask_by_crop_areas(., crop_area) %>%
  norm_values(., probs = scale_probs) %>%
  data_to_analysis_unit(data_in = .,
                        aunit_raster = aunit_raster,
                        aunit_data = analysis_unit_data,
                        indicator_name = "suitability",
                        cfun = "mean")

# combine all indicators
indicator_data_all <- bind_rows(subnat_hdi,
                                governance,
                                water_stress,
                                suitability,
                                fertilizers,
                                irrigation) %>%
  dplyr::select(crop_name, indicator, value, to07, holdridge, zones) %>%
  drop_na()

indicator_data <- indicator_data_all %>%
  filter(holdridge %in% holdridge_selected) %>%
  filter(indicator %in% preds) %>%
  pivot_wider(id_cols = c(crop_name, holdridge, zones),
              values_from = "value", names_from = "indicator")


# add country id and hexagon id to the indicator data
cntry_sf <- rnaturalearth::ne_countries(returnclass = "sf") %>%
  filter(sovereignt != "Antarctica") %>%
  mutate(area_id = row_number())

cntry_raster <- fasterize(sf = cntry_sf, raster = cell_ids, field = "area_id" )
names(cntry_raster) <- "country"

continent_sf <- cntry_sf %>%
  group_by(continent) %>%
  summarise() %>%
  mutate(continent_id = row_number())


continent_names <- continent_sf %>%
  mutate(continent_name = continent) %>%
  select(continent_name, continent_id) %>%
  st_drop_geometry()

continents <- fasterize(sf = continent_sf, raster = cell_ids,
                        field = "continent_id")
names(continents) <- "continent"

state_raster <- fasterize(states, cell_ids, "state_id")
names(state_raster) <- "state"


join_tbl <- zonal(stack(state_raster,
                       cntry_raster,
                       continents),
                 cell_ids) %>%
  as_tibble() %>%
  drop_na()

indicator_data <- left_join(indicator_data, join_tbl, by = c("zones" = "zone")) %>%
    drop_na()

# Make a hexagon grid and attach ids of hexagons to the indicator data

hex_grid <- sf::st_make_grid(continent_sf,
                         n = c(100,100),
                         what = "polygons",
                         square = FALSE,
                         flat_topped = TRUE
                          )



hex_grid_points <- exactextractr::exact_extract(cell_ids, hex_grid) %>%
  bind_rows(.id = "hex_id") %>%
  group_by(value) %>%
  top_n(n = 1, wt = coverage_fraction) %>%
  ungroup() %>%
  mutate(zones = as.numeric(value),
         hex_id = as.numeric(hex_id)) %>%
  select(-c(value, coverage_fraction))


indicator_data <- left_join(indicator_data, hex_grid_points, by = c("zones"))

# Load yield data

# load crop data to analysis units
run_crop_data_import(path_to_crop_data, aunit_filename, path_to_results, shock_size = shock_threshold)

# long term variability of the yield anomaly
crop_yield_var <-
  read_csv(file.path(path_to_results,"relative_crop_yields_anom.csv")) %>%
  #feather::read_feather(file.path(path_to_results,"relative_crop_yields_anom.feather")) %>%
  pivot_longer(cols = year1981:year2009,
               names_to = "year",
               values_to = "yield_anom") %>%
  mutate(year = year %>%  str_remove("year") %>% as.numeric()) %>%
  drop_na() %>%
  group_by(area_id, crop_name) %>%
  filter(n() > 15) %>%
  mutate(mean_val = mean(yield_anom, na.rm = T)) %>%
  filter(yield_anom < 0) %>%
  mutate(semivar_i = (0 - yield_anom)^2) %>%
  dplyr::summarise(yield_anom_var = sqrt(sum(semivar_i)/n()))
#
# crop_yield_anom <-
#   feather::read_feather(file.path(path_to_results,"relative_crop_yields_anom.feather")) %>%
#   pivot_longer( cols = year1981:year2009,
#                 names_to = "year",
#                 values_to = "yield_anom") %>%
#   mutate(year = year %>%  str_remove("year") %>% as.numeric()) %>%
#   drop_na()


# climate_anomalies <-
#   feather::read_feather(file.path(path_to_results,"climate_anomalies.feather")) %>%
#   pivot_longer(cols = year1981:year2009,
#                names_to = "year",
#                values_to = "climate_anom") %>%
#   mutate(year = year %>%  str_remove("year") %>% as.numeric()) %>%
#   drop_na()


# Yield anomalies adjusted by the size of the temp/soil moisture shock
clim_anom_adj_yields <-
  read_csv(file.path(path_to_results,"crop_yields_clim_adjusted.csv")) %>%
  #feather::read_feather(file.path(path_to_results,"crop_yields_clim_adjusted.feather")) %>%
  pivot_longer(cols = year1981:year2009, names_to = "year",
               values_to = "clim_adjusted_anom") %>%
  mutate(year = year %>% str_remove("year") %>% as.numeric()) %>%
  drop_na() %>%
  dplyr::select(-variable_name) %>%
  group_by(area_id, crop_name, variable, shock_type) %>%
  summarise(long_term_mean = mean(clim_adjusted_anom, na.rm = TRUE),
            .groups = "keep") %>%
  drop_na()

# mean non adjusted yield anom for shock years
clim_shock_yields <-
  read_csv(file.path(path_to_results,"crop_yields_anom_shocks.csv")) %>%
  #feather::read_feather(file.path(path_to_results,"crop_yields_anom_shocks.feather")) %>%
  pivot_longer(cols = year1981:year2009,
               names_to = "year",
               values_to = "yield_anoms_shock") %>%
  mutate(year = year %>% str_remove("year") %>% as.numeric()) %>%
  dplyr::select(-variable_name) %>%
  filter(!is.infinite(yield_anoms_shock)) %>%
  left_join(analysis_unit_data, by =c("area_id"="gridCell")) %>%
  group_by(area_id, crop_name, variable, shock_type) %>%
  drop_na() %>%
  dplyr::summarise(long_term_mean = mean(yield_anoms_shock, na.rm = TRUE),
                   .groups = "keep") %>%
  drop_na()


# harvested area size
harvested_area <-  read_csv(file.path(path_to_results,"harvested_area.csv")) %>%
  pivot_longer(cols = year1981:year2010,
               names_to = "year",
               values_to = "harvested_area") %>%
  mutate(year = year %>% str_remove("year") %>% as.numeric()) %>%
  filter(year == 2000) %>%
  filter(!is.infinite(harvested_area)) %>%
  left_join(analysis_unit_data, by =c("area_id"="gridCell")) %>%
  group_by(area_id, crop_name) %>%
  dplyr::summarise(harv_area = mean(harvested_area, na.rm = TRUE),
                   .groups = "keep") %>%
  drop_na()


# Calculate crop extents within each continent and holdridge zone
crop_sf <- st_as_stars(crop_area) %>%
  st_as_sf() %>%
  gather(key = "crop_name", value = "extent",all_of(crops_selected)) %>%
  drop_na() %>%
  group_by(crop_name) %>%
  summarise(extent = sum(extent))

crop_continent <- st_intersection(continent_sf, crop_sf) %>%
  st_buffer(0) %>%
  mutate(continent_name = continent) %>%
  select(-continent)

crop_holdridge <- st_intersection(holdridge_crs, crop_sf) %>%
  group_by(crop_name, holdridge) %>%
  summarise() %>%
  st_buffer(0) %>%
  mutate(crop_name = factor(crop_name, levels = crops_selected),
         holdridge = factor(holdridge, levels = holdridge_order))


# save intermediary data
 if (save_temp_data) {
  save.image(file.path(path_to_results, "/indicator_data_files.RData"))
}
