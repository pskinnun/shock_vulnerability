################################################
# Paper title:	Over half of the negative crop yield variability explained by anthropogenic indicators
# Authors:	Pekka Kinnunen*, Matias Heino, Vilma Sandstr√∂m, Maija Taka, Deepak K. Ray, Matti Kummu*
##
# Code author: Pekka Kinnunen
# Script loads needed packages and other  configuration information
#################################################

# load packages for all scripts
rm(list = ls())

list_of_cran_packages <- c("caret","glmnet","outliers", "foreach", "raster","sf","tmap",
                      "rnaturalearth","R.utils","reticulate","scico","ggridges",
                      "pdp","xgboost","parallel","feather","fasterize", "GGally","slider","RStoolbox",
                      "doParallel","parallel","rlist","ncdf4","wbstats","tidyverse","parsnip","egg",
                      "assertthat", "here", "yaml", "exactextractr", "SHAPforxgboost", "ggthemes","doMC","ggdist",
                      "patchwork", "ggrepel","gghighlight","ALEPlot","stars","rgeos", "inlmisc")

list_of_gh_packages <- c("wilkelab/ungeviz","HannaMeyer/CAST")
gh_packages <- lapply(list_of_gh_packages, remotes::install_github)


# TODO: separate packages from github and clean unused packages

new_packages <- list_of_cran_packages[!(list_of_cran_packages %in% installed.packages()[,"Package"])]
if (length(new_packages) > 0) install.packages(new_packages)

list_of_packages <- c(list_of_cran_packages, gh_packages)

packages_in <- lapply(list_of_packages, require, character.only = TRUE, quietly = T)
assertthat::assert_that(all(unlist(packages_in)) == TRUE,
                        msg = "failed to load packages")

source("utils_data_load.R")
source("utils_analysis.R")
# set working directory

setwd(here::here())
getwd()

# save results to folder
save_results <- TRUE
show_results <- TRUE
save_temp_data <- TRUE
load_temp_data <- FALSE
override_results <- F

if (save_results) {
  path_to_results <- create_folder(override_results)
}

run_date <- Sys.Date()

### PATHS TO DATA
path_to_crop_data <- "../data/crop_data/"
path_to_temp_data <- "temp_data/"
path_python_files <- "../Python/crop_yield_data.py"

reticulate::source_python(path_python_files)

### MODEL INPUTS
## select input variables for the models

crops_selected <- c("wheat", "maize","soybean","rice")
shock_types <- c("dry", "hot")
preds <- c("shdi",
           "governance",
           "fertilizerPCA",
           "waterstress",
           "suitability",
           "irrigation")


pred_names <- c("shdi" = "HDI","governance" = "GOV",
                "waterstress"= "WS", "irrigation" = "WINF",
                "fertilizerPCA" = "FER", "suitability" = "SI")


nfolds <- 10
nthreshold <- 200
run_parallel <- TRUE
run_cluster <- FALSE

# threshold for shock size, standard deviations in hot (cold) and dry (wet) days
shock_threshold <- 1

# split data by these variables

analysis_groups <- c("crop_name","holdridge")
analysis_groups_shocks <- c("crop_name", "holdridge", "shock_type")

target_shock <- "long_term_mean"
target_name <- "yield_anom_var"
spacevar <- "hex_id"

ntunes <- 50

if (run_cluster) {
  ncores <- as.integer(Sys.getenv('SLURM_CPUS_PER_TASK', parallel::detectCores()))
} else {
  ncores <- parallel::detectCores()
}

# set seeds for cv batches
model_seeds <- seeds <- vector(mode = "list", length = nfolds + 1)
for (i in 1:nfolds) model_seeds[[i]] <- sample.int(n = 1000, ntunes)
model_seeds[[nfolds + 1]] <- sample.int(1000, 1)

## Input data
# raster resolution
analysis_level <- "grid"
res_in <-  0.5
r_temp <- raster::raster(nrow = 180 / res_in, ncol = 360 / res_in,
                         xmn = -180, xmx = 180, ymn = -90, ymx = 90)

# scale input variables  to this range
scale_probs <- c(0.025, 0.975)

# years
years_selected <- 1995:2005
ts_timeperiod <- 1990:2010

### result visualization

# Plot specs
plot_height <- unit(7.3, "in")
plot_width <- unit(7.3, "in")


# select Holdridge region data, remapped = 7 Holdridge zones and filter out
# polar regions

path_to_holdridge <- "../data/Holdridge_Life_Zones/holdridge_remapped.shp"

sf::sf_use_s2(FALSE)

if (grepl("remap", path_to_holdridge)) {
  holdridge <- st_read(path_to_holdridge,stringsAsFactors = FALSE) %>%
    filter(!is.na(name07)) %>%
    mutate(holdridge = name07) %>%
    select(-name07) %>%
    st_buffer(0)


} else {
  holdridge <- st_read(path_to_holdridge, stringsAsFactors = FALSE) %>%
    filter(!is.na(desc_)) %>%
    mutate(holdridge = desc_) %>%
    dplyr::select(-c(desc_,st_area_sh, objectid)) %>%
    st_buffer(0)
}

holdridge_selected <- holdridge %>%
  st_drop_geometry() %>%
  filter(holdridge != "Polar and cold") %>%
  pull(holdridge)


holdridge_crs <- st_transform(holdridge,crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0") %>%
  st_buffer(0)


holdridge_order <- c("Cool","Temperate", "Steppe", "Arid",
                     "Subtropical", "Humid tropical")

crop_colors <- RColorBrewer::brewer.pal(4, "Dark2")

RColorBrewer::display.brewer.pal(4, "Dark2")
names(crop_colors) <- crops_selected

shock_colors <- inlmisc::GetColors(n = 3, scheme = "high-contrast")

names(shock_colors) <- c("1981-2009","dry years","hot years")


holdridge_colors <- GetColors(length(holdridge_order)+1)[2:(length(holdridge_order)+1)]

# save used model specs to a yaml file

yaml_list <- list("run_date" = as.character(run_date),
                  "crops_selected" = crops_selected,
                  "preds" = preds,
                  "nthreshold" = nthreshold,
                  "nfolds" = nfolds,
                  #"model_seeds" = model_seeds,
                  "path_to_holdridge" = path_to_holdridge,
                  "analysis_level" = analysis_level,
                  "res_in" = res_in,
                  "years_selected" = years_selected,
                  "ts_timeperiod" = ts_timeperiod,
                  "scale_probs" = scale_probs,
                  "shock_types" = shock_types,
                  "shock_threshold" = shock_threshold,
                  "spacevar" = spacevar)

filename <- file.path(path_to_results, "model_spefications.yaml")
con <- file(filename, "w")
write_yaml(yaml_list, con)
close(con)

# run input data or download previously saved variables
# if (load_temp_data) {
#   load(file.path(path_to_results, "/indicator_data_files.RData"))
# } else {
#   source("1-load_data.R")
# }


## source analysis scripts
source("1-load_data.R")
source('2-explore.R')
source("3_1-analysis_relative_anom.R")
source("3_2-shock_analysis.R")
source("4_1-map_visualize.R")
source("4_2-plot_visualize.R")

